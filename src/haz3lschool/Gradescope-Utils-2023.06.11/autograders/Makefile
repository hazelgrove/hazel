## specific autograders
# run_test stub
default: lib setup.sh
	# fatpack so we don't have to ship our own modules
	perl -c run_test.lean.pl
	fatpack pack run_test.lean.pl > run_test.fat.pl
	zip AG *
# code upload sanity check
check-hazel: lib setup.sh
	perl -c run_test.$@.lean.pl
	fatpack pack run_test.$@.lean.pl > run_test.fat.pl
	zip AG *
# grade haz3l A1
grade-hazel: lib setup.sh
	perl -c run_test.$@.lean.pl
	fatpack pack run_test.$@.lean.pl > run_test.fat.pl
	zip AG *
# grade A8 rustviz quiz
rustviz-quiz: lib setup.sh
	perl -c run_test.$@.lean.pl
	fatpack pack run_test.$@.lean.pl > run_test.fat.pl
	zip AG *
# grade A8 repair rust
repair-rust: lib setup.sh
	perl -c run_test.$@.lean.pl
	fatpack pack run_test.$@.lean.pl > run_test.fat.pl
	zip AG *

## other stuff
lib: $(shell find ../lib)
	rsync -a ../lib/ lib
setup.sh: setup.base.sh
	cp setup.base.sh setup.sh
	echo '# THIS FILE IS AUTOGENERATED-- SEE MAKEFILE' >> setup.sh
	scandeps.pl run_test.lean.pl -V | perl -ne 'print if m/\#.*X.*\?/ and !m/\[X\]/' | perl -e 'local $$/ = undef; $$in = <STDIN>; $$kv = eval "{$$in}"; print "cpanm $$_\n" for keys %$$kv' >> setup.sh

clean:
	-rm -r AG.zip lib setup.sh

.PHONY: default hazel clean
